<!DOCTYPE html>
{% extends 'base.html' %}
{% block title %}Modules 5-6: Real-Time Object Tracker{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card module-card shadow mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fas fa-crosshairs me-2"></i>Modules 5-6: Real-Time Object Tracker</h2>
                    <div class="tracker-controls mb-3">
                        <label for="mode" class="form-label">Tracking Mode:</label>
                        <select id="mode" class="form-select d-inline-block w-auto" style="max-width:300px;">
                            <option value="marker">Marker-based (Aruco/QR/April)</option>
                            <option value="markerless">Markerless (OpenCV)</option>
                            <option value="sam2">SAM2 Segmentation</option>
                        </select>
                        <button id="initBtn" class="btn btn-primary ms-2">Init Tracker</button>
                        <button id="stopBtn" class="btn btn-danger ms-2">Stop Tracker</button>
                    </div>
                    <div id="sam2-upload" style="display:none;">
                        <label for="sam2file" class="form-label">Upload SAM2 NPZ Mask:</label>
                        <input type="file" id="sam2file" class="form-control" accept=".npz">
                        <button id="uploadBtn" class="btn btn-secondary mt-2">Upload Mask</button>
                    </div>
                    <div class="mt-4 position-relative d-flex justify-content-center" style="width:100%;">
                        <video id="video" width="640" height="480" autoplay muted class="border rounded"></video>
                        <canvas id="overlay" width="640" height="480" style="position:absolute;top:0;left:0;"></canvas>
                    </div>
                    <div class="mt-3">
                        <span id="status" class="text-success"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const modeSelect = document.getElementById('mode');
const initBtn = document.getElementById('initBtn');
const stopBtn = document.getElementById('stopBtn');
const sam2UploadDiv = document.getElementById('sam2-upload');
const sam2File = document.getElementById('sam2file');
const uploadBtn = document.getElementById('uploadBtn');
const statusSpan = document.getElementById('status');
let tracking = false;
let trackerMode = 'marker';

modeSelect.addEventListener('change', () => {
    trackerMode = modeSelect.value;
    sam2UploadDiv.style.display = trackerMode === 'sam2' ? 'block' : 'none';
});

initBtn.onclick = async () => {
    statusSpan.textContent = `ðŸŽ¯ Initializing ${trackerMode} tracker...`;
    tracking = true;
    
    try {
        await startStreaming();
        statusSpan.textContent = `âœ… Tracker initialized (${trackerMode}) - Ready to track!`;
    } catch (error) {
        statusSpan.textContent = `âŒ Failed to initialize: ${error.message}`;
        tracking = false;
    }
};

stopBtn.onclick = async () => {
    tracking = false;
    statusSpan.textContent = 'â¹ï¸ Tracker stopped';
    ctx.clearRect(0, 0, overlay.width, overlay.height);
    
    // Stop video stream
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }
};

uploadBtn.onclick = async () => {
    const file = sam2File.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('file', file);
    const res = await fetch('/module5/api/sam2/upload', {
        method: 'POST',
        body: formData
    });
    const data = await res.json();
    statusSpan.textContent = data.status || data.error;
};

async function startStreaming() {
    if (!navigator.mediaDevices.getUserMedia) {
        statusSpan.textContent = 'Webcam not supported';
        return;
    }
    const stream = await navigator.mediaDevices.getUserMedia({video: true});
    video.srcObject = stream;
    requestAnimationFrame(processFrame);
}

async function processFrame() {
    if (!tracking) return;
    
    // Simple mock tracking - just display the video feed with overlay text
    ctx.clearRect(0, 0, overlay.width, overlay.height);
    
    // Add tracking mode indicator
    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    ctx.fillRect(10, 10, 200, 30);
    ctx.fillStyle = 'white';
    ctx.font = '16px Arial';
    ctx.fillText(`Tracking Mode: ${trackerMode}`, 15, 30);
    
    // Add frame counter
    ctx.fillStyle = 'rgba(0, 255, 0, 0.7)';
    ctx.fillRect(10, 50, 150, 25);
    ctx.fillStyle = 'black';
    ctx.font = '14px Arial';
    ctx.fillText(`Status: Active`, 15, 67);
    
    requestAnimationFrame(processFrame);
}
</script>
{% endblock %}
