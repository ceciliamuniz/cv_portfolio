{% extends 'base.html' %}
{% block title %}Module 3 - Part 5: SAM2 Comparison{% endblock %}
{% block head %}
  <style>
    .container-narrow { max-width: 1200px; margin: 20px auto; padding: 0 16px; }
    .info { padding: 0.75rem; background: #f4f7fb; border: 1px solid #d9e3f0; border-radius: 6px; margin-bottom: 1rem; }
    .error { padding: 0.75rem; background: #fff5f5; border: 1px solid #f0cccc; border-radius: 6px; margin-bottom: 1rem; color: #a00; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1 1 320px; }
    input[type="file"] { padding: 6px; }
    input[type="text"] { width: 100%; padding: 6px; }
    button { padding: 8px 14px; background: #0069c2; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:disabled { background: #aaa; }
    img { max-width: 100%; height: auto; border-radius: 6px; border: 1px solid #ddd; }
    .result { margin-top: 1rem; }
    code { background: #f6f8fa; padding: 2px 4px; border-radius: 4px; }
  </style>
{% endblock %}
{% block content %}
  <div class="container-narrow">
    <h1 class="h3 my-3">Part 5: SAM2 Comparison</h1>

  {% if not sam2_available %}
    <div class="error">SAM2 isn't available. Install PyTorch and SAM2, then provide a checkpoint. {{ error or '' }}</div>
  {% endif %}

  <div class="info">
    <p>Upload an image with visible ArUco markers. We'll segment using ArUco prompts and compare to SAM2.</p>
    <ul>
      <li>Checkpoint path defaults to <code>part5_sam2_comparison/checkpoints/sam2_hiera_large.pt</code> if left empty.</li>
      <li>We use ArUco marker centers as positive point prompts for SAM2.</li>
    </ul>
  </div>

  <form id="sam2Form" method="post" enctype="multipart/form-data">
    <div class="row">
      <div class="col">
        <label>Image File</label><br />
        <input type="file" name="file" accept="image/*" required />
      </div>
      <div class="col">
        <label>SAM2 Checkpoint (optional)</label><br />
        <input type="text" name="checkpoint_path" placeholder="path/to/sam2_checkpoint.pt" />
      </div>
    </div>
    <p><button type="submit" {% if not sam2_available %}disabled{% endif %}>Run Comparison</button></p>
  </form>

  <div id="result" class="result"></div>

  <script>
    const form = document.getElementById('sam2Form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const res = await fetch('', { method: 'POST', body: data });
      const json = await res.json();
      const out = document.getElementById('result');
      if (!json.success) {
        out.innerHTML = `<div class="error">${json.error || 'Failed to process image.'}</div>`;
        return;
      }
      out.innerHTML = `
        <div class="info">
          <div><strong>IoU:</strong> ${json.metrics.iou.toFixed(3)} | <strong>Dice:</strong> ${json.metrics.dice.toFixed(3)} | <strong>Precision:</strong> ${json.metrics.precision.toFixed(3)} | <strong>Recall:</strong> ${json.metrics.recall.toFixed(3)}</div>
        </div>
        <div class="row">
          <div class="col"><h3>Comparison</h3><img src="${json.comparison_url}" alt="Comparison"/></div>
          <div class="col"><h3>SAM2 Mask</h3><img src="${json.sam2_mask_url}" alt="SAM2 Mask"/></div>
          <div class="col"><h3>ArUco Mask</h3><img src="${json.aruco_mask_url}" alt="ArUco Mask"/></div>
        </div>
      `;
    });
  </script>

  <p><a href="/module3">Back to Module 3</a></p>
  </div>
{% endblock %}
