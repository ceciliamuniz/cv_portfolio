<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Module 5: Real-Time Object Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        #video, #overlay {
            max-width: 100%;
            border: 1px solid #ccc;
        }
        #overlay {
            position: absolute;
            top: 0; left: 0;
            pointer-events: none;
        }
        .tracker-controls {
            margin-bottom: 1em;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <h2>Module 5: Real-Time Object Tracker</h2>
    <div class="tracker-controls">
        <label for="mode" class="form-label">Tracking Mode:</label>
        <select id="mode" class="form-select" style="max-width:300px;">
            <option value="marker">Marker-based (Aruco/QR/April)</option>
            <option value="markerless">Markerless (OpenCV)</option>
            <option value="sam2">SAM2 Segmentation</option>
        </select>
        <button id="initBtn" class="btn btn-primary ms-2">Init Tracker</button>
        <button id="stopBtn" class="btn btn-danger ms-2">Stop Tracker</button>
    </div>
    <div id="sam2-upload" style="display:none;">
        <label for="sam2file" class="form-label">Upload SAM2 NPZ Mask:</label>
        <input type="file" id="sam2file" class="form-control" accept=".npz">
        <button id="uploadBtn" class="btn btn-secondary mt-2">Upload Mask</button>
    </div>
    <div class="mt-4 position-relative" style="width:640px;">
        <video id="video" width="640" height="480" autoplay muted></video>
        <canvas id="overlay" width="640" height="480"></canvas>
    </div>
    <div class="mt-3">
        <span id="status" class="text-success"></span>
    </div>
</div>
<script>
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const modeSelect = document.getElementById('mode');
const initBtn = document.getElementById('initBtn');
const stopBtn = document.getElementById('stopBtn');
const sam2UploadDiv = document.getElementById('sam2-upload');
const sam2File = document.getElementById('sam2file');
const uploadBtn = document.getElementById('uploadBtn');
const statusSpan = document.getElementById('status');
let tracking = false;
let trackerMode = 'marker';

modeSelect.addEventListener('change', () => {
    trackerMode = modeSelect.value;
    sam2UploadDiv.style.display = trackerMode === 'sam2' ? 'block' : 'none';
});

initBtn.onclick = async () => {
    const res = await fetch('/api/track/init', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({mode: trackerMode})
    });
    const data = await res.json();
    if (data.status === 'initialized') {
        statusSpan.textContent = `Tracker initialized (${trackerMode})`;
        tracking = true;
        startStreaming();
    } else {
        statusSpan.textContent = data.error || 'Failed to initialize tracker';
    }
};

stopBtn.onclick = async () => {
    await fetch('/api/track/stop', {method: 'POST'});
    tracking = false;
    statusSpan.textContent = 'Tracker stopped';
    ctx.clearRect(0, 0, overlay.width, overlay.height);
};

uploadBtn.onclick = async () => {
    const file = sam2File.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('file', file);
    const res = await fetch('/api/sam2/upload', {
        method: 'POST',
        body: formData
    });
    const data = await res.json();
    statusSpan.textContent = data.status || data.error;
};

async function startStreaming() {
    if (!navigator.mediaDevices.getUserMedia) {
        statusSpan.textContent = 'Webcam not supported';
        return;
    }
    const stream = await navigator.mediaDevices.getUserMedia({video: true});
    video.srcObject = stream;
    requestAnimationFrame(processFrame);
}

async function processFrame() {
    if (!tracking) return;
    ctx.clearRect(0, 0, overlay.width, overlay.height);
    // Capture frame from video
    ctx.drawImage(video, 0, 0, overlay.width, overlay.height);
    const frame = overlay.toDataURL('image/jpeg');
    // Convert base64 to binary
    const b64 = frame.split(',')[1];
    const bin = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    // Send frame to backend
    const res = await fetch('/api/track', {
        method: 'POST',
        body: bin
    });
    if (res.ok) {
        const blob = await res.blob();
        const img = new Image();
        img.onload = () => {
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            ctx.drawImage(img, 0, 0, overlay.width, overlay.height);
        };
        img.src = URL.createObjectURL(blob);
    }
    requestAnimationFrame(processFrame);
}
</script>
</body>
</html>
