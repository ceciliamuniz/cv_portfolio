<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Module 4 - Advanced Image Stitching | CV Portfolio</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .navbar-brand { font-weight: bold; }
    .main-content { padding: 20px 0; }
    .card { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    .progress { display: none; }
    .metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .quality-indicator { font-size: 1.2em; font-weight: bold; }
    .result-image { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .module-badge { 
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">
        <i class="fas fa-eye"></i> CV Portfolio
        <span class="module-badge">Module 4</span>
      </a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">
              <i class="fas fa-home"></i> Home
            </a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="modulesDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-graduation-cap"></i> Modules
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/module1">
                <i class="fas fa-ruler"></i> Module 1: Distance Measurement
              </a></li>
              <li><a class="dropdown-item" href="/module2">
                <i class="fas fa-search"></i> Module 2: Template Matching & Deblurring
              </a></li>
              <li><a class="dropdown-item" href="/module3">
                <i class="fas fa-image"></i> Module 3: Image Processing Pipeline
              </a></li>
              <li><a class="dropdown-item active" href="/module4">
                <i class="fas fa-images"></i> Module 4: Image Stitching
              </a></li>
              <li><a class="dropdown-item" href="/module5">
                <i class="fas fa-cube"></i> Module 5: Advanced CV
              </a></li>
              <li><a class="dropdown-item" href="/module7">
                <i class="fas fa-robot"></i> Module 7: AI Integration
              </a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/module4">
              <i class="fas fa-images"></i> Image Stitching
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="main-content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h1 class="mb-0"><i class="fas fa-images"></i> Module 4: Advanced Image Stitching</h1>
            <p class="mb-0 mt-2">Complete SIFT implementation from scratch with RANSAC optimization and OpenCV comparison</p>
            <small class="text-light">
              <i class="fas fa-user"></i> Cecilia Muniz Siqueira | 
              <i class="fas fa-calendar"></i> November 2025 | 
              <i class="fas fa-code"></i> Computer Vision Portfolio
            </small>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <strong><i class="fas fa-info-circle"></i> Requirements:</strong>
              Upload <strong>at least 4 landscape images</strong> (horizontal orientation) or <strong>8 portrait images</strong> (vertical orientation) for panorama creation.
            </div>

            <form id="stitchForm" enctype="multipart/form-data">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label"><i class="fas fa-upload"></i> Select Images</label>
                    <input class="form-control" type="file" id="images" name="images" accept="image/*" multiple required>
                    <div class="form-text">Select multiple images in sequence (left to right for panorama)</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label"><i class="fas fa-palette"></i> Blending Mode</label>
                    <select class="form-select" id="blendMode" name="blend_mode">
                      <option value="multiband" selected>Multi-band (Best Quality)</option>
                      <option value="feather">Feather Blending</option>
                      <option value="simple">Simple Average</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="useCustomSift" name="use_custom_sift" checked>
                      <label class="form-check-label" for="useCustomSift">
                        <i class="fas fa-code"></i> Use Custom SIFT Implementation
                      </label>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="comparisonMode" name="comparison_mode">
                      <label class="form-check-label" for="comparisonMode">
                        <i class="fas fa-balance-scale"></i> Enable SIFT Comparison
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="fas fa-magic"></i> Create Panorama
                </button>
                <button type="button" class="btn btn-outline-secondary" id="clearBtn">
                  <i class="fas fa-trash"></i> Clear
                </button>
              </div>
            </form>

            <div class="progress mt-3" id="progressBar">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="results" class="row" style="display: none;">
      <!-- Results will be populated here -->
    </div>

    <div id="comparison" class="row" style="display: none;">
      <!-- Comparison results will be populated here -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const form = document.getElementById('stitchForm');
    const progressBar = document.getElementById('progressBar');
    const progressBarInner = progressBar.querySelector('.progress-bar');
    const resultsDiv = document.getElementById('results');
    const comparisonDiv = document.getElementById('comparison');
    const clearBtn = document.getElementById('clearBtn');

    // File input change handler
    document.getElementById('images').addEventListener('change', function(e) {
      const files = e.target.files;
      const fileCount = files.length;
      
      if (fileCount > 0) {
        const fileList = Array.from(files).map(f => f.name).join(', ');
        console.log(`Selected ${fileCount} files: ${fileList}`);
        
        // Show file count feedback
        const existingFeedback = document.querySelector('.file-feedback');
        if (existingFeedback) existingFeedback.remove();
        
        const feedback = document.createElement('div');
        feedback.className = 'alert alert-success mt-2 file-feedback';
        feedback.innerHTML = `<i class="fas fa-check-circle"></i> Selected ${fileCount} images`;
        e.target.parentNode.appendChild(feedback);
      }
    });

    // Clear button handler
    clearBtn.addEventListener('click', function() {
      form.reset();
      resultsDiv.style.display = 'none';
      comparisonDiv.style.display = 'none';
      progressBar.style.display = 'none';
      
      const feedback = document.querySelector('.file-feedback');
      if (feedback) feedback.remove();
    });

    // Form submission handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const files = document.getElementById('images').files;
      const minFiles = 4; // Can be adjusted based on orientation
      
      if (files.length < minFiles) {
        alert(`Please upload at least ${minFiles} images for panorama stitching`);
        return;
      }

      // Prepare form data
      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        formData.append('images', files[i]);
      }
      formData.append('blend_mode', document.getElementById('blendMode').value);
      formData.append('use_custom_sift', document.getElementById('useCustomSift').checked);
      formData.append('comparison_mode', document.getElementById('comparisonMode').checked);

      // Show progress
      showProgress('Initializing...');
      
      try {
        // Update progress during processing
        updateProgress(25, 'Processing images...');
        
        const response = await fetch('/api/stitch', {
          method: 'POST',
          body: formData
        });
        
        updateProgress(90, 'Finalizing...');
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Stitching failed');
        }
        
        updateProgress(100, 'Complete!');
        setTimeout(() => {
          hideProgress();
          displayResults(result);
        }, 500);
        
      } catch (error) {
        hideProgress();
        showError(error.message);
      }
    });

    function showProgress(message) {
      progressBar.style.display = 'block';
      progressBarInner.style.width = '10%';
      progressBarInner.textContent = message;
    }

    function updateProgress(percent, message) {
      progressBarInner.style.width = percent + '%';
      progressBarInner.textContent = message;
    }

    function hideProgress() {
      progressBar.style.display = 'none';
    }

    function showError(message) {
      resultsDiv.innerHTML = `
        <div class="col-12">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> ${message}
          </div>
        </div>
      `;
      resultsDiv.style.display = 'block';
    }

    function displayResults(result) {
      const stats = result.statistics || {};
      const quality = result.quality_metrics || {};
      
      resultsDiv.innerHTML = `
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h3 class="mb-0"><i class="fas fa-check-circle"></i> Panorama Created Successfully</h3>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-lg-8">
                  <h4>Result</h4>
                  <img src="${result.panorama}" class="result-image img-fluid mb-3" alt="Generated Panorama">
                </div>
                <div class="col-lg-4">
                  <h4>Statistics</h4>
                  <div class="card metric-card mb-3">
                    <div class="card-body">
                      <div class="row text-center">
                        <div class="col-6">
                          <div class="h4">${stats.input_images || 0}</div>
                          <small>Input Images</small>
                        </div>
                        <div class="col-6">
                          <div class="h4">${stats.output_resolution || 'N/A'}</div>
                          <small>Output Resolution</small>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  ${quality.overall_quality ? `
                  <div class="card mb-3">
                    <div class="card-body">
                      <h5>Quality Score</h5>
                      <div class="quality-indicator text-${getQualityColor(quality.overall_quality)}">
                        ${(quality.overall_quality * 100).toFixed(1)}%
                      </div>
                      <div class="progress mt-2">
                        <div class="progress-bar bg-${getQualityColor(quality.overall_quality)}" 
                             style="width: ${quality.overall_quality * 100}%"></div>
                      </div>
                    </div>
                  </div>
                  ` : ''}
                  
                  ${stats.processing_time ? `
                  <div class="card">
                    <div class="card-body">
                      <h6><i class="fas fa-clock"></i> Processing Time</h6>
                      <p class="mb-0">${stats.processing_time}</p>
                    </div>
                  </div>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      resultsDiv.style.display = 'block';
      
      // Display comparison results if available
      if (result.comparison) {
        displayComparison(result.comparison);
      }
    }

    function displayComparison(comparison) {
      const custom = comparison.custom || {};
      const opencv = comparison.opencv || {};
      
      comparisonDiv.innerHTML = `
        <div class="col-12 mt-4">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h4 class="mb-0"><i class="fas fa-balance-scale"></i> SIFT Implementation Comparison</h4>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h5><i class="fas fa-code"></i> Custom SIFT</h5>
                  <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Keypoints:</span>
                      <strong>${custom.keypoints_count || 0}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Matches:</span>
                      <strong>${custom.matches_count || 0}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Processing Time:</span>
                      <strong>${custom.processing_time ? custom.processing_time.toFixed(2) + 's' : 'N/A'}</strong>
                    </li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h5><i class="fas fa-external-link-alt"></i> OpenCV SIFT</h5>
                  <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Keypoints:</span>
                      <strong>${opencv.keypoints_count || 0}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Matches:</span>
                      <strong>${opencv.matches_count || 0}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Processing Time:</span>
                      <strong>${opencv.processing_time ? opencv.processing_time.toFixed(2) + 's' : 'N/A'}</strong>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      comparisonDiv.style.display = 'block';
    }

    function getQualityColor(score) {
      if (score >= 0.7) return 'success';
      if (score >= 0.4) return 'warning';
      return 'danger';
    }


  </script>
</body>
</html>
